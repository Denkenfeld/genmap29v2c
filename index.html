<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ParadiseFinder 2025 ‚Äì Ultimate Expat Tool (three-globe)</title>
    
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,eyJpY29ucyI6IFt7InNyYyI6ICJodHRwczovL2Vtb2ppaXZlLW9iamVjdHMuczMtZWFzdC0yLWFtYXpvbmF3cy5jb20vMDBkMGQyMmMtNmExNy00ZWMwLWI4ZGQtNmQ0OTc1Yjk0OTNmLzAxMWQxNmFhLTJmM2EtNGM1MS1iMDA1LTQ2OWRmNTE3OWI5ZC5qcGciLCJzaXplcyI6ICIxOTJ4MTkyIn0sIHsic3JjIjogImh0dHBzOi8vZW1vaml2ZS1vYmplY3RzLnMzLWVhc3QtMi1hbWFhem9uYXdzLmNvbS8wMGQwZDIyYy02YTE3LTRlYzAtYjhkZC02ZDQ5NzViOTQ5M2YvMDExZDE2YWEtMmYzYS00YzUxLWIwMDUtNDY5ZGY1MTc5YjlkLmpwZyIsInNpemVzIjoiNTEyeDUxMiJ9XSwgIm5hbWUiOiAiUGFyYWRpc2VGaW5kZXIiLCAic2hvcnRfbmFtZSI6ICJQYXJhZGlzZUZpbmRlciIsICJkaXNwbGF5IjogInN0YW5kYWxvbmUiIH0=">

    <script src="https://unpkg.com/globe.gl@4.36.7/dist/globe.gl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #0aff68;
            --bg-dark: #050510;
            --bg-glass: rgba(10, 15, 30, 0.85); 
            --border-glass: 1px solid rgba(0, 243, 255, 0.2);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Reset and Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background-color: var(--bg-dark); font-family: var(--font-main); color: #fff; }
        
        /* Three.js Container */
        #globe-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* General Panel Styling (Z-Index erh√∂ht, da Globe jetzt Z-Index 1 ist) */
        .panel { position: absolute; pointer-events: auto; background: var(--bg-glass); backdrop-filter: blur(25px); border: var(--border-glass); border-radius: 16px; padding: 24px; z-index: 10; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8); transition: all 0.4s ease; max-height: 95vh; scrollbar-width: thin; scrollbar-color: rgba(0, 243, 255, 0.4) rgba(0, 0, 0, 0.2); }
        #panel-left { top: 20px; left: 20px; width: 380px; bottom: 20px; overflow-y: scroll; }
        #panel-right { top: 20px; right: 20px; width: 420px; bottom: 20px; overflow-y: scroll; transform: translateX(120%); }
        #panel-right.active { transform: translateX(0); }
        h2 { margin: 0 0 15px 0; font-weight: 400; font-size: 18px; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        h3 { font-size: 13px; color: #fff; margin-top: 15px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

        /* Form, Ranking, Results (Unver√§ndert) */
        label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #aaa; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: rgba(0,0,0,0.5); height: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--neon-blue); border-radius: 50%; cursor: grab; box-shadow: 0 0 10px var(--neon-blue); }
        input[type=number] { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444; color: #fff; padding: 6px; border-radius: 4px; font-size: 14px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .ranking-item { display: flex; justify-content: space-between; padding: 8px 10px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 14px; background: rgba(0,0,0,0.3); }
        .ranking-item:hover { background: rgba(0, 243, 255, 0.1); }
        .score-indicator { width: 5px; height: 100%; margin-right: 10px; border-radius: 2px; }
        .big-stat-box { background: rgba(0,243,255,0.05); border: 1px solid rgba(0,243,255,0.2); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .stat-circle-score { font-size: 56px; font-weight: 300; display: block; text-shadow: 0 0 30px rgba(0,243,255,0.5); }
        .f-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px; }
        .cash-flow { font-size: 20px; font-weight: bold; margin-top: 10px; }
        .btn-main { width: 100%; padding: 14px; margin-top: 20px; background: linear-gradient(90deg, #00c6ff, #0072ff); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

        /* Loading (Unver√§ndert) */
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-dark); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction: column; transition: opacity 1s; }
        .progress-bar { width: 300px; height: 3px; background: rgba(255,255,255,0.1); margin-top: 15px; border-radius: 2px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--neon-blue); width: 0%; transition: width 0.3s; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(0,243,255,0.3); border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* three-globe Billboards (mit CSS2D Renderer) */
        .globe-billboard {
            pointer-events: all;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--neon-blue);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #fff;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 0 8px rgba(0, 243, 255, 0.3);
            transition: background 0.2s;
        }
        .globe-billboard:hover { background: rgba(0, 243, 255, 0.15); }
        .billboard-score { font-weight: bold; margin-left: 5px; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:20px; font-size:14px; letter-spacing:2px; color:var(--neon-blue);" id="loader-text">Scanne 258 Paradiese und kalibriere Geo-Daten...</div>
        <div class="progress-bar"><div class="progress-bar-fill" id="progress-fill"></div></div>
    </div>
    
    <div id="globe-container"></div>

    <div id="panel-left" class="panel">
        <h2>System-Pr√§ferenzen</h2>
        
        <div class="input-group">
            <div style="flex:2;"><label>Jahreseinkommen Brutto (‚Ç¨)</label><input type="number" id="income" value="120000" step="10000"></div>
            <div style="flex:1;"><label>Erwachsene</label><input type="number" id="adults" value="2" min="1" max="10"></div>
            <div style="flex:1;"><label>Kinder</label><input type="number" id="children" value="2" min="0" max="10"></div>
        </div>

        <h3>Ranking Top 10 (Score: 75% Kriterien + 25% Finanzen)</h3>
        <div id="ranking-list"></div>

        <h3>Gewichtung der 28 Kriterien (0 - 100 %)</h3>
        <div id="sliders-container"></div>
    </div>

    <div id="panel-right" class="panel">
        <button style="position:absolute; top:15px; right:15px; background:none; border:none; color:var(--neon-blue); font-size:24px; cursor:pointer;" onclick="closeRightPanel()">‚úï</button>
        <h2 id="country-name">Zielort w√§hlen</h2>

        <div class="big-stat-box">
            <span class="stat-circle-score" id="match-score" style="color:var(--neon-blue);">0%</span>
            <span style="font-size:10px; letter-spacing:2px; text-transform:uppercase; color:#aaa;">Globaler Match Score</span>
        </div>

        <h3>Finanzanalyse</h3>
        <div class="finance-grid">
            <div class="f-row"><span>Effektiver Steuersatz</span><span id="tax-rate" style="font-weight:bold;">0%</span></div>
            <div class="f-row"><span>Netto nach Steuern / Jahr</span><span id="net-income"></span></div>
            <div class="f-row"><span>Lebenshaltung (Fam. Sch√§tzung) / Jahr</span><span id="living-cost"></span></div>
            <div class="f-row cash-flow">
                <span>√úbrig pro Monat</span>
                <span id="cashflow-monthly"></span>
            </div>
        </div>
        
        <div style="margin: 20px 0; padding:15px; border-left: 4px solid var(--neon-green); background: rgba(10,255,104,0.1);">
            <div style="font-size:11px; text-transform:uppercase; color:var(--neon-green); font-weight:bold;">Verm√∂gens-Turbo (vs. DE 42% Steuer)</div>
            <div style="font-size:20px; font-weight:bold; margin-top:5px;" id="wealth-gain"></div>
            <div style="font-size:12px; color:#aaa;">Mehrverm√∂gen nach 10 Jahren (optimiert)</div>
        </div>

        <h3>Hard Facts & Programme</h3>
        <div id="details-container" style="font-size:14px; line-height:1.6; color:#ccc;"></div>

        <button class="btn-main" onclick="generatePDF()">üìÑ PDF Report (Offiziell) Generieren</button>
    </div>

    <div id="pdf-content" style="position:fixed; top:-9999px; left:0; width:800px; background:#fff; color:#111; padding:50px; font-family:'Helvetica', sans-serif;">
        <h1 style="color:#0072ff; border-bottom:2px solid #0072ff;">ParadiseFinder 2025: Auswanderungs-Report</h1>
        <div id="pdf-body"></div>
    </div>

    <script>
        // ==========================================
        // 1. GLOBALE KONSTANTEN & DATENBANK
        // ==========================================
        const BASE_INCOME_DE = 120000;
        const TAX_RATE_DE = 0.42; 
        const MONTHLY_COST_DE = 2500 * (2 + 2 * 0.6); 
        
        const QUESTIONS = [
            "Einfache langfristige Aufenthaltsgenehmigung", "Realistischer Weg zur Staatsb√ºrgerschaft", 
            "H√∂chste Sicherheit & extrem niedrige Kriminalit√§t", "Internationale Schulen in absoluter Top-Qualit√§t", 
            "Krankenh√§user & √Ñrzte auf deutschem Niveau", "Englisch als t√§gliche Alltagssprache", 
            "0 % Einkommensteuer auf weltweites Einkommen", "0 % Kapitalertragssteuer (Dividenden, Aktien, Krypto)", 
            "Keine oder extrem niedrige Verm√∂genssteuer", "Keine Erbschafts- und Schenkungssteuer", 
            "Sehr niedrige Grund- und Immobiliensteuer", "Moderate bis niedrige Lebenshaltungskosten", 
            "Schnelles und stabiles Internet (>200 MBit)", "Kurze Flugzeit nach Europa (<12h ideal)", 
            "Angenehmes Klima ohne Extremwetter", "Zeitzone maximal ¬±4 Stunden zu CET", 
            "Gro√üe, aktive Expat-Community (vor allem Europ√§er)", "Sehr kinder- und familienfreundliche Kultur", 
            "EU-F√ºhrerschein wird sofort anerkannt", "Bankkonto einfach als Ausl√§nder er√∂ffnen", 
            "Krypto legal & steuerfrei nutzbar", "Doppelbesteuerungsabkommen mit DE/AT/CH", 
            "Wegzugsbesteuerung Deutschlands vermeidbar", "Echte langfristige Residency (kein Visa-Run)", 
            "Politische Stabilit√§t & Rechtsstaatlichkeit", "Europ√§ische Lebensmittel leicht verf√ºgbar", 
            "Exit jederzeit m√∂glich (Kapital rausbringbar)", "Top Kinder-Infrastruktur (Spielpl√§tze, Freizeit, Schulen)"
        ];
        
        const HIGH_VALUE_DESTINATIONS = [
            {"name":"Dubai (UAE)","lat":25.2048,"lng":55.2708,"flag":"üá¶üá™","tax":0,"living":78000,"residency":"Golden Visa ab 500k‚Ç¨","scores":[1,1,1,0.95,1,1,1,1,1,1,0.7,0.6,0.95,0.7,0.8,0.9,1,0.9,0.9,1,1,1,0.9,1,1,0.9,1,1]},
            {"name":"Madeira (Portugal)","lat":32.7607,"lng":-16.9595,"flag":"üáµüáπ","tax":10,"living":42000,"residency":"NHR 2.0 bis mind. 2034","scores":[1,0.9,0.95,0.95,0.95,0.85,0.9,0.9,1,1,0.9,0.9,0.9,0.95,1,1,1,0.95,1,1,0.9,1,1,1,1,0.95,1,1]},
            {"name":"Malta & Gozo","lat":35.9375,"lng":14.3754,"flag":"üá≤üáπ","tax":15,"living":54000,"residency":"Permanent Residency ‚Ç¨150k","scores":[1,1,0.95,0.9,0.95,1,0.85,0.85,1,1,0.8,0.75,0.9,1,0.95,0.95,1,1,1,1,0.95,1,1,1,1,0.95,1,1]},
            {"name":"Zypern (Limassol)","lat":34.7071,"lng":33.0226,"flag":"üá®üáæ","tax":12.5,"living":52000,"residency":"Permanent Residency ‚Ç¨300k","scores":[1,0.9,0.95,0.95,0.95,1,0.85,0.85,1,0.95,0.8,0.8,0.9,1,0.95,0.95,1,1,1,1,0.95,1,1,1,1,0.95,1,1]},
            {"name":"Mauritius","lat":-20.3484,"lng":57.5522,"flag":"üá≤üá∫","tax":15,"living":48000,"residency":"Premium Visa (Long-Stay)","scores":[1,0.9,0.95,0.9,0.9,0.9,1,1,1,1,0.85,0.75,0.8,0.5,0.8,0.4,0.7,0.9,1,1,1,0.8,0.9,1,1,0.9,0.95,1]},
            {"name":"Cayman Islands","lat":19.3133,"lng":-81.2546,"flag":"üá∞üáæ","tax":0,"living":110000,"residency":"Residency by Investment","scores":[1,1,1,0.95,1,1,1,1,1,1,0.5,0.3,0.9,0.4,0.9,0.7,0.8,0.9,0.9,1,1,1,0.8,0.9,1,0.8,0.7,1]},
            {"name":"Georgien (Tbilisi)","lat":41.7151,"lng":44.8271,"flag":"üá¨üá™","tax":1,"living":30000,"residency":"1% Small Business Status","scores":[0.95,0.8,0.85,0.9,0.85,0.7,0.98,0.98,1,1,0.95,0.95,0.9,0.9,0.8,0.9,0.6,0.85,0.95,0.9,0.9,0.9,1,1,0.8,0.9,1,0.95]},
            {"name":"Panama","lat":8.9824,"lng":-79.5199,"flag":"üáµüá¶","tax":0,"living":48000,"residency":"Friendly Nations Visa","scores":[0.95,0.85,0.9,0.9,0.9,0.8,1,1,1,1,0.85,0.8,0.8,0.8,0.7,0.5,0.6,0.85,1,1,1,0.7,0.9,1,0.9,0.85,0.95,1]},
            {"name":"Bali","lat":-8.6525,"lng":115.1453,"flag":"üáÆüá©","tax":30,"living":36000,"residency":"B211A + KITAS","scores":[0.9,0.3,0.85,0.95,0.85,1,0.7,0.7,0.9,1,0.9,1,0.7,0.2,0.8,0.1,0.7,1,0.9,0.9,0.8,0.6,0.8,0.7,0.7,0.9,0.9,0.9]},
            {"name":"Phuket","lat":7.9519,"lng":98.3382,"flag":"üáπüá≠","tax":35,"living":42000,"residency":"LTR Visa 10 Jahre","scores":[0.9,0.2,0.8,0.95,0.85,1,0.6,0.6,0.9,1,0.9,1,0.8,0.3,0.8,0.3,0.6,1,0.9,0.9,0.7,0.5,0.7,0.7,0.7,0.9,0.9,0.9]},
            {"name":"Teneriffa","lat":28.2916,"lng":-16.6291,"flag":"üá™üá∏","tax":24,"living":45000,"residency":"Non-Lucrative Visa","scores":[1,0.7,0.95,1,0.95,0.9,0.7,0.7,0.8,0.8,0.9,0.9,0.9,0.95,1,1,1,1,1,1,0.9,1,1,1,1,0.95,1,1]},
            {"name":"Mallorca","lat":39.6953,"lng":2.9787,"flag":"üá™üá∏","tax":24,"living":55000,"residency":"Non-Lucrative Visa","scores":[1,0.65,0.95,1,0.95,0.9,0.65,0.65,0.7,0.7,0.85,0.85,0.9,1,1,1,1,1,1,1,0.9,1,1,1,1,0.95,1,1]},
            {"name":"Monaco","lat":43.7334,"lng":7.4190,"flag":"üá≤üá®","tax":0,"living":150000,"residency":"Ordinary Residency","scores":[0.95,0.7,1,1,1,0.7,1,1,1,1,0.5,0.05,0.99,0.95,0.8,1,0.7,0.9,1,1,1,0.9,0.9,0.95,1,1,0.9,1]},
            {"name":"Andorra","lat":42.5063,"lng":1.5218,"flag":"üá¶üá©","tax":10,"living":55000,"residency":"Active Residency","scores":[0.9,0.7,1,0.9,0.95,0.6,0.9,0.95,1,1,0.8,0.7,0.9,0.95,0.7,1,0.7,0.9,1,1,1,0.9,0.9,0.9,1,1,1,1]}
        ];
        
        let destinations = [];
        const TOTAL_LOCATIONS = 258; 
        let weights = new Array(QUESTIONS.length).fill(0.5);
        let Globe = null;

        // ==========================================
        // 2. PROZEDURALE DATEN GENERIERUNG 
        // ==========================================
        function generateProceduralLocations() {
            destinations = HIGH_VALUE_DESTINATIONS.map(d => ({
                ...d, calc: {}, id: 'HV_' + d.name.replace(/\W/g, ''), real: true,
                lat: d.lat, lng: d.lng, altitude: 0.05 
            }));

            while (destinations.length < TOTAL_LOCATIONS) {
                const parent = HIGH_VALUE_DESTINATIONS[Math.floor(Math.random() * HIGH_VALUE_DESTINATIONS.length)];
                destinations.push({
                    name: `Region ${destinations.length + 1} (${parent.flag})`,
                    lat: parent.lat + (Math.random() - 0.5) * 15, lng: parent.lng + (Math.random() - 0.5) * 15,
                    flag: 'üåê', tax: Math.max(5, parent.tax + Math.round((Math.random() - 0.5) * 10)),
                    living: parent.living * (0.8 + Math.random() * 0.4),
                    residency: 'Lokales Programm (Simuliert)',
                    scores: Array(QUESTIONS.length).fill(0).map(() => Math.max(0.2, (Math.random() * 0.3) + 0.3)), 
                    real: false, calc: {}, id: 'PR_' + destinations.length,
                    altitude: Math.random() * 0.05 + 0.01 
                });
            }
            document.getElementById('progress-fill').style.width = '50%';
        }


        // ==========================================
        // 3. GLOBE.GL / THREE-GLOBE INITIALISIERUNG
        // ==========================================

        function initGlobe() {
            Globe = window.Globe()
                (document.getElementById('globe-container'))
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg') 
                .backgroundColor('#050510')
                .showAtmosphere(true)
                .atmosphereColor('#00f3ff')
                .atmosphereAltitude(0.25)
                .pointColor(d => {
                    // Stabile Initialisierung: Fallback, falls calc.score noch nicht existiert
                    const score = d.calc && d.calc.score ? d.calc.score : 50;
                    const h = (score / 100) * 0.33; 
                    return `hsl(${h * 360}, 100%, 60%)`;
                })
                .pointAltitude('altitude') 
                .pointRadius(d => 0.2 + (d.calc && d.calc.score ? d.calc.score / 100 : 0.5) * 0.2) 
                .pointsData(destinations)
                .pointLabel(d => `${d.flag} ${d.name} (${Math.round(d.calc.score)}%)`) 
                .onPointClick(selectLocation) 
                .controlsState({ 
                    autoRotate: true, 
                    autoRotateSpeed: 0.8 
                });
            
            // --- HTML Elements Layer ---
            Globe.htmlElementsData(destinations)
                 .htmlLat('lat')
                 .htmlLng('lng')
                 .htmlAltitude(d => d.altitude + 0.01) 
                 .htmlElement(d => {
                    const el = document.createElement('div');
                    el.className = 'globe-billboard';
                    el.id = 'billboard-' + d.id;
                    el.innerHTML = `${d.flag} ${d.name} <span class="billboard-score">0%</span>`;
                    return el;
                 })
                 .htmlTransitionDuration(500); 
            
            // Initiales Rendering und Anpassung
            window.addEventListener('resize', () => Globe.width(window.innerWidth).height(window.innerHeight));
            Globe.width(window.innerWidth).height(window.innerHeight);

            document.getElementById('progress-fill').style.width = '75%';
            
            // KORREKTUR: F√ºhre calculate() sofort aus, um die d.calc-Daten zu initialisieren
            calculate(); 
        }


        // ==========================================
        // 4. CORE ENGINE (SCORING & FINANCE)
        // ==========================================
        
        function setupUIAndListeners() {
            const sliderCont = document.getElementById('sliders-container');
            QUESTIONS.forEach((q, i) => {
                const div = document.createElement('div');
                const labelText = `${i+1}. ${q}`;
                const safeId = `slider-${i}`;
                div.className = 'control-group';
                div.innerHTML = `<label for="${safeId}">${labelText}</label><input type="range" id="${safeId}" min="0" max="100" value="50" oninput="updateWeight(${i}, this.value)">`;
                sliderCont.appendChild(div);
            });

            ['income', 'adults', 'children'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculate);
            });
            document.getElementById('progress-fill').style.width = '85%';
        }
        
        window.updateWeight = (idx, val) => {
            weights[idx] = val / 100;
            calculate();
        }

        window.calculate = () => {
            const income = parseFloat(document.getElementById('income').value) || BASE_INCOME_DE;
            const adults = parseFloat(document.getElementById('adults').value) || 2;
            const children = parseFloat(document.getElementById('children').value) || 2;
            
            const familyFactor = adults + (children * 0.6);
            const netDE = income * (1 - TAX_RATE_DE);
            const cashflowDE = netDE - (MONTHLY_COST_DE * 12);

            destinations.forEach((d) => {
                // Scoring
                let scoreSum = 0; let weightSum = 0;
                d.scores.forEach((s, i) => { scoreSum += s * weights[i]; weightSum += weights[i]; });
                const softScore = weightSum > 0 ? (scoreSum / weightSum) : 0;
                const net = income * (1 - (d.tax / 100));
                const living = (d.living / (2 + 2 * 0.6)) * familyFactor; 
                const cashflow = net - living;
                const maxBonusThreshold = 60000;
                const financeBonus = Math.min(Math.max(cashflow, 0), maxBonusThreshold) / maxBonusThreshold;
                const finalScore = (softScore * 0.75) + (financeBonus * 0.25);
                
                d.calc = {
                    score: finalScore * 100, net: net, living: living, cashflow: cashflow,
                    cashflowMonthly: cashflow / 12, wealthDelta: (cashflow - cashflowDE) * 10 
                };

                // Update HTML Billboard Score
                const billboardEl = document.getElementById('billboard-' + d.id);
                if (billboardEl) {
                    const scoreEl = billboardEl.querySelector('.billboard-score');
                    const score = Math.round(d.calc.score);
                    scoreEl.innerText = score + "%";
                    scoreEl.style.color = score > 80 ? 'var(--neon-green)' : (score > 50 ? '#ffcc00' : '#ff3366');
                }
            });

            // Daten-Update an Globe senden, um Farben/Gr√∂√üen zu aktualisieren
            if (Globe) {
                Globe.pointsData(destinations);
            }

            updateRanking();
        }

        function updateRanking() {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            
            const sorted = destinations.map((d) => d)
                                       .sort((a, b) => b.calc.score - a.calc.score)
                                       .slice(0, 10);

            sorted.forEach((item, i) => {
                const el = document.createElement('div');
                const score = Math.round(item.calc.score);
                let color;
                if(score > 80) color = 'var(--neon-green)';
                else if(score > 50) color = '#ffcc00';
                else color = '#ff3366';

                el.className = 'ranking-item';
                el.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span style="color:#666; width:20px; font-size:12px;">#${i+1}</span>
                        <div style="background:${color};" class="score-indicator"></div>
                        <span>${item.flag} ${item.name}</span>
                    </div>
                    <span class="rank-score" style="color:${color};">${score}%</span>
                `;
                el.onclick = () => selectLocation(item);
                list.appendChild(el);
            });
        }
        
        // ==========================================
        // 5. INTERAKTIONEN (FLIEGEN & UI)
        // ==========================================

        window.selectLocation = (data) => {
            selectedData = data;
            
            // Kamera Fly (Nutzung der Globe.GL-Methode)
            if(Globe) {
                Globe.pointOfView({ lat: data.lat, lng: data.lng, altitude: 1.5 }, 1500); 
            }
            
            // UI-Populate (Unver√§ndert)
            document.getElementById('country-name').innerText = `${data.flag} ${data.name}`;
            
            const score = Math.round(data.calc.score);
            const scoreEl = document.getElementById('match-score');
            scoreEl.innerText = score + "%";
            scoreEl.style.color = score > 80 ? 'var(--neon-green)' : (score > 50 ? '#ffcc00' : '#ff3366');

            document.getElementById('tax-rate').innerText = data.tax + " %";
            document.getElementById('net-income').innerText = Math.round(data.calc.net).toLocaleString('de-DE') + " ‚Ç¨";
            document.getElementById('living-cost').innerText = Math.round(data.calc.living).toLocaleString('de-DE') + " ‚Ç¨";
            
            const cfMonthlyEl = document.getElementById('cashflow-monthly');
            const cashflowMonthly = Math.round(data.calc.cashflowMonthly);
            cfMonthlyEl.innerText = cashflowMonthly.toLocaleString('de-DE') + " ‚Ç¨";
            cfMonthlyEl.style.color = cashflowMonthly > 0 ? 'var(--neon-green)' : '#ff3366';

            const wealth = data.calc.wealthDelta / 1000000;
            const wEl = document.getElementById('wealth-gain');
            wEl.innerText = (wealth >= 0 ? "+" : "") + wealth.toFixed(2) + " Mio ‚Ç¨";
            wEl.style.color = wealth > 0 ? 'var(--neon-green)' : (wealth === 0 ? '#fff' : '#ff3366');

            document.getElementById('details-container').innerHTML = `
                <p><strong>Residency Programm:</strong> ${data.residency}</p>
                <p><strong>Geodaten:</strong> ${data.lat.toFixed(2)}¬∞ Lat, ${data.lng.toFixed(2)}¬∞ Lng</p>
                <p><strong>Quelle:</strong> ${data.real ? 'Echter Top-Expat-Standort (Expertendaten)' : 'Simulierter Hub (Prozedural)'}</p>
                <p style="margin-top:15px; border-top: 1px dashed #333; padding-top:10px;">
                    <strong>Familien-Fokus:</strong> ${data.scores[27] > 0.8 ? 'Sehr hohe' : 'Moderate'} Kinder-Infrastruktur.
                </p>
            `;

            document.getElementById('panel-right').classList.add('active');
        }

        window.closeRightPanel = () => {
            document.getElementById('panel-right').classList.remove('active');
        }

        // PDF Generation (Unver√§ndert)
        function generatePDF() {
            if(!selectedData) return alert("Bitte w√§hlen Sie zuerst einen Standort aus der Liste!");
            const d = selectedData;
            
            const pdfBody = document.getElementById('pdf-body');
            pdfBody.innerHTML = `
                <h2 style="color:#0072ff; font-size:28px;">${d.flag} ${d.name}</h2>
                <p style="font-size:14px; color:#555;">Match Score: ${Math.round(d.calc.score)}% | Effektiver Steuersatz: ${d.tax}%</p>
                
                <div style="margin-top:30px; border:1px solid #ccc; padding:20px; border-radius:5px;">
                    <h3 style="color:#333; border-bottom:1px solid #ddd; padding-bottom:10px;">FINANZIELLE KENNZAHLEN (10 JAHRE)</h3>
                    <p style="font-size:22px; color:#4CAF50; font-weight:bold; margin-top:15px;">√úBRIG PRO JAHR: ${Math.round(d.calc.cashflow).toLocaleString('de-DE')} ‚Ç¨</p>
                    <p style="font-size:16px;">Netto-Einkommen: ${Math.round(d.calc.net).toLocaleString('de-DE')} ‚Ç¨</p>
                    <p style="font-size:16px;">Gesch√§tzte Lebenshaltung: ${Math.round(d.calc.living).toLocaleString('de-DE')} ‚Ç¨</p>
                    <p style="font-size:18px; font-weight:bold; margin-top:20px;">VERM√ñGENSVORTEIL vs. DE: ${document.getElementById('wealth-gain').innerText}</p>
                </div>
                
                <div style="margin-top:20px;">
                    <h3 style="color:#333; border-bottom:1px solid #ddd; padding-bottom:10px;">PROGRAMM & DETAILS</h3>
                    <p><strong>Residency-Programm:</strong> ${d.residency}</p>
                    ${document.getElementById('details-container').innerHTML}
                </div>
            `;

            const element = document.getElementById('pdf-content');
            element.style.top = "0"; 
            
            html2pdf().from(element).save(`ParadiseReport_${d.name.replace(/\W/g,'_')}.pdf`).then(() => {
                element.style.top = "-9999px"; 
            });
        }

        // --- Initialization ---
        function initApp() {
            generateProceduralLocations();
            setupUIAndListeners();
            initGlobe(); // Initialisiert den Globe und die HTML-Layer
            
            // Ladeanimation ausblenden
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').remove(), 1000);
            
            // KORREKTUR: Verz√∂gerung des ersten Fly-to-Effekts, um dem Globe Zeit zum Initialisieren zu geben
            setTimeout(() => {
                if (destinations.length > 0) {
                    const topDestination = destinations.sort((a, b) => b.calc.score - a.calc.score)[0];
                    
                    // F√ºhrt den "Fly" aus
                    Globe.pointOfView({ lat: topDestination.lat, lng: topDestination.lng, altitude: 1.5 }, 1500);
                    
                    // W√§hlt den Standort im UI aus
                    selectLocation(topDestination);
                }
            }, 2500); // 2.5 Sekunden Wartezeit
        }

        window.onload = initApp;

    </script>
</body>
</html>
